{"version":3,"sources":["../../../source/lib/workbook/builder.js"],"names":["xmlbuilder","require","JSZip","fs","CTColor","utils","addRootContentTypesXML","promiseObj","Promise","resolve","reject","xml","create","att","contentTypesAdded","extensionsAdded","wb","sheets","forEach","s","i","drawingCollection","length","drawings","d","indexOf","extension","contentType","typeRef","ele","push","Object","keys","comments","legacyDrawingHeaderFooter","sheetId","chartsCollection","items","xmlString","doc","end","xmlOutVars","xlsx","file","addRootRelsXML","folder","addWorkbookXML","booksViewEle","workbookViewEle","opts","workbookView","viewOpts","activeTab","undefined","firstVisibleTab","sheet","hidden","autoFilterDateGrouping","boolToInt","firstSheet","minimized","showHorizontalScroll","showSheetTabs","showVerticalScroll","tabRatio","visibility","windowWidth","windowHeight","xWindow","yWindow","showComments","sheetsEle","name","printArea","startCellRef","getExcelAlpha","startCol","startRow","endCellRef","endCol","endRow","definedNameCollection","addDefinedName","localSheetId","refFormula","isEmpty","addToXMLele","calculationProperties","calcPr","fullCalculationOnLoad","addWorkbookRelsXML","addCorePropertiesXML","text","author","dtStr","Date","toISOString","addWorksheetsXML","curSheet","processNextSheet","thisSheet","generateXML","then","generateRelsXML","generateCommentsXML","generateCommentsVmlXML","catch","e","logger","error","stack","addSharedStringsXML","sharedStrings","txt","Array","thisSI","theseRuns","currProps","curRun","props","k","value","run","thisRun","thisRunProps","bold","italics","strike","outline","shadow","condense","extend","color","thisColor","size","underline","vertAlign","addStylesXML","styleData","numFmts","nfXML","nf","fontXML","fonts","f","fillXML","fills","fXML","borderXML","borders","b","cellXfsXML","styles","addXFtoXMLele","dxfCollection","addDrawingsXML","mediaCollection","ws","drawingRelXML","drawingsXML","kind","target","id","image","imagePath","readFileSync","rId","type","chartBuilder","chartPartXML","chartXMLStr","drawingsXMLStr","drawingRelXMLStr","addLegacyHeaderFooterDrawingsXML","drawingsVML","begin","sl","st","vf","writeToBuffer","Worksheet","jszip","generateAsync","buf","workbookXML","result","files","_data","module","exports"],"mappings":"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","file":"builder.js","sourcesContent":["const xmlbuilder = require('xmlbuilder');\r\nconst JSZip = require('jszip');\r\nconst fs = require('fs');\r\nconst CTColor = require('../style/classes/ctColor.js');\r\nconst utils = require('../utils');\r\n\r\nlet addRootContentTypesXML = (promiseObj) => {\r\n  // Required as stated in §12.2\r\n  return new Promise((resolve, reject) => {\r\n    let xml = xmlbuilder.create(\r\n      'Types', {\r\n      'version': '1.0',\r\n      'encoding': 'UTF-8',\r\n      'standalone': true,\r\n      'allowSurrogateChars': true\r\n    }\r\n    )\r\n      .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/content-types');\r\n\r\n    let contentTypesAdded = [];\r\n    let extensionsAdded = [];\r\n    promiseObj.wb.sheets.forEach((s, i) => {\r\n      if (s.drawingCollection.length > 0) {\r\n        s.drawingCollection.drawings.forEach((d) => {\r\n          if (extensionsAdded.indexOf(d.extension) < 0) {\r\n            if (d.contentType) {\r\n              let typeRef = d.contentType + '.' + d.extension;\r\n              if (contentTypesAdded.indexOf(typeRef) < 0) {\r\n                xml.ele('Default').att('ContentType', d.contentType).att('Extension', d.extension);\r\n              }\r\n              extensionsAdded.push(d.extension);\r\n            }\r\n          }\r\n        });\r\n      }\r\n      if (Object.keys(s.comments).length > 0) {\r\n        if (extensionsAdded.indexOf('vml') < 0) {\r\n          xml.ele('Default').att('Extension', 'vml').att('ContentType', 'application/vnd.openxmlformats-officedocument.vmlDrawing');\r\n          extensionsAdded.push('vml');\r\n        }\r\n      }\r\n\r\n      if (s.legacyDrawingHeaderFooter.length > 0) {\r\n        if (extensionsAdded.indexOf('vml') < 0) {\r\n          xml.ele('Default').att('Extension', 'vml').att('ContentType', 'application/vnd.openxmlformats-officedocument.vmlDrawing');\r\n          extensionsAdded.push('vml');\r\n        }\r\n        if (extensionsAdded.indexOf('png') < 0) {\r\n          xml.ele('Default').att('Extension', 'png').att('ContentType', 'image/png');\r\n          extensionsAdded.push('png');\r\n        }\r\n      }\r\n    });\r\n    xml.ele('Default').att('Extension', 'xml').att('ContentType', 'application/xml');\r\n    xml.ele('Default').att('Extension', 'rels').att('ContentType', 'application/vnd.openxmlformats-package.relationships+xml');\r\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml').att('PartName', '/xl/workbook.xml');\r\n    promiseObj.wb.sheets.forEach((s, i) => {\r\n      xml.ele('Override')\r\n        .att('PartName', `/xl/worksheets/sheet${i + 1}.xml`)\r\n        .att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml')\r\n\r\n\r\n      if (s.drawingCollection.length > 0) {\r\n        xml.ele('Override')\r\n          .att('PartName', '/xl/drawings/drawing' + s.sheetId + '.xml')\r\n          .att('ContentType', 'application/vnd.openxmlformats-officedocument.drawing+xml')\r\n      }\r\n      if (Object.keys(s.comments).length > 0) {\r\n        xml.ele('Override')\r\n          .att('PartName', '/xl/comments' + s.sheetId + '.xml')\r\n          .att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.comments+xml')\r\n      }\r\n    });\r\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml').att('PartName', '/xl/styles.xml');\r\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml').att('PartName', '/xl/sharedStrings.xml');\r\n    xml.ele('Override').att('ContentType', 'application/vnd.openxmlformats-package.core-properties+xml').att('PartName', '/docProps/core.xml');\r\n    promiseObj.wb.chartsCollection.items.forEach((s, i) => {\r\n      xml.ele('Override')\r\n        .att('PartName', `/xl/charts/chart${i + 1}.xml`)\r\n        .att('ContentType', 'application/vnd.openxmlformats-officedocument.drawingml.chart+xml')\r\n    })\r\n\r\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n    promiseObj.xlsx.file('[Content_Types].xml', xmlString);\r\n    resolve(promiseObj);\r\n  });\r\n};\r\n\r\nlet addRootRelsXML = (promiseObj) => {\r\n  // Required as stated in §12.2\r\n  return new Promise((resolve, reject) => {\r\n    let xml = xmlbuilder.create(\r\n      'Relationships', {\r\n      'version': '1.0',\r\n      'encoding': 'UTF-8',\r\n      'standalone': true,\r\n      'allowSurrogateChars': true\r\n    }\r\n    )\r\n      .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\r\n\r\n    xml\r\n      .ele('Relationship')\r\n      .att('Id', 'rId1')\r\n      .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument')\r\n      .att('Target', 'xl/workbook.xml');\r\n\r\n    xml\r\n      .ele('Relationship')\r\n      .att('Id', 'rId2')\r\n      .att('Type', 'http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties')\r\n      .att('Target', 'docProps/core.xml');\r\n\r\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n    promiseObj.xlsx.folder('_rels').file('.rels', xmlString);\r\n    resolve(promiseObj);\r\n\r\n  });\r\n};\r\n\r\nlet addWorkbookXML = (promiseObj) => {\r\n  // Required as stated in §12.2\r\n  return new Promise((resolve, reject) => {\r\n\r\n    let xml = xmlbuilder.create(\r\n      'workbook', {\r\n      'version': '1.0',\r\n      'encoding': 'UTF-8',\r\n      'standalone': true,\r\n      'allowSurrogateChars': true\r\n    }\r\n    );\r\n    xml.att('mc:Ignorable', 'x15');\r\n    xml.att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\r\n    xml.att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006');\r\n    xml.att('xmlns:r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships');\r\n    xml.att('xmlns:x15', 'http://schemas.microsoft.com/office/spreadsheetml/2010/11/main');\r\n    xml.att('xmlns:x', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\r\n\r\n    let booksViewEle = xml.ele('bookViews');\r\n    let workbookViewEle = booksViewEle.ele('workbookView');\r\n    // bookViews (§18.2.1)\r\n    if (promiseObj.wb.opts.workbookView) {\r\n      const viewOpts = promiseObj.wb.opts.workbookView;\r\n      if (viewOpts.activeTab !== null && viewOpts.activeTab !== undefined) {\r\n        workbookViewEle.att('activeTab', viewOpts.activeTab);\r\n      } else {\r\n        let firstVisibleTab = 0;\r\n        for (let i = 0; i < promiseObj.wb.sheets.length; i++) {\r\n          const sheet = promiseObj.wb.sheets[i];\r\n          if (!sheet.opts.hidden) {\r\n            firstVisibleTab = i;\r\n            break;\r\n          }\r\n        }\r\n        workbookViewEle.att('activeTab', firstVisibleTab);\r\n      }\r\n      if (viewOpts.autoFilterDateGrouping) {\r\n        workbookViewEle.att('autoFilterDateGrouping', utils.boolToInt(viewOpts.autoFilterDateGrouping));\r\n      }\r\n      if (viewOpts.firstSheet) {\r\n        workbookViewEle.att('firstSheet', viewOpts.firstSheet);\r\n      }\r\n      if (viewOpts.minimized) {\r\n        workbookViewEle.att('minimized', utils.boolToInt(viewOpts.minimized));\r\n      }\r\n      if (viewOpts.showHorizontalScroll) {\r\n        workbookViewEle.att('showHorizontalScroll', utils.boolToInt(viewOpts.showHorizontalScroll));\r\n      }\r\n      if (viewOpts.showSheetTabs) {\r\n        workbookViewEle.att('showSheetTabs', utils.boolToInt(viewOpts.showSheetTabs));\r\n      }\r\n      if (viewOpts.showVerticalScroll) {\r\n        workbookViewEle.att('showVerticalScroll', utils.boolToInt(viewOpts.showVerticalScroll));\r\n      }\r\n      if (viewOpts.tabRatio) {\r\n        workbookViewEle.att('tabRatio', viewOpts.tabRatio);\r\n      }\r\n      if (viewOpts.visibility) {\r\n        workbookViewEle.att('visibility', viewOpts.visibility);\r\n      }\r\n      if (viewOpts.windowWidth) {\r\n        workbookViewEle.att('windowWidth', viewOpts.windowWidth);\r\n      }\r\n      if (viewOpts.windowHeight) {\r\n        workbookViewEle.att('windowHeight', viewOpts.windowHeight);\r\n      }\r\n      if (viewOpts.xWindow) {\r\n        workbookViewEle.att('xWindow', viewOpts.xWindow);\r\n      }\r\n      if (viewOpts.yWindow) {\r\n        workbookViewEle.att('yWindow', viewOpts.yWindow);\r\n      }\r\n      if (viewOpts.showComments) {\r\n        workbookViewEle.att('showComments', viewOpts.showComments);\r\n      }\r\n    }\r\n\r\n    let sheetsEle = xml.ele('sheets');\r\n    promiseObj.wb.sheets.forEach((s, i) => {\r\n      const sheet = sheetsEle.ele('sheet')\r\n        .att('name', s.name)\r\n        .att('sheetId', i + 1)\r\n        .att('r:id', `rId${i + 1}`);\r\n\r\n      if (s.opts.hidden) {\r\n        sheet.att('state', 'hidden');\r\n      }\r\n\r\n      if (s.printArea) {\r\n        const name = s.name;\r\n        const startCellRef = `$${utils.getExcelAlpha(s.printArea.startCol)}$${s.printArea.startRow}`;\r\n        const endCellRef = `$${utils.getExcelAlpha(s.printArea.endCol)}$${s.printArea.endRow}`;\r\n        s.wb.definedNameCollection.addDefinedName({\r\n          name: '_xlnm.Print_Area',\r\n          localSheetId: s.localSheetId,\r\n          refFormula: `'${name}'!${startCellRef}:${endCellRef}`,\r\n        });\r\n      }\r\n    });\r\n\r\n    if (!promiseObj.wb.definedNameCollection.isEmpty) {\r\n      promiseObj.wb.definedNameCollection.addToXMLele(xml);\r\n    }\r\n\r\n    if(promiseObj.wb.opts.calculationProperties){\r\n      let calcPr = xml.ele('x:calcPr');\r\n      if(promiseObj.wb.opts.calculationProperties.fullCalculationOnLoad){\r\n        // calcPr.att('calcId', 15234)\r\n        calcPr.att('fullCalcOnLoad', 1)\r\n      }\r\n    }\r\n\r\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n    promiseObj.xlsx.folder('xl').file('workbook.xml', xmlString);\r\n    resolve(promiseObj);\r\n\r\n  });\r\n};\r\n\r\nlet addWorkbookRelsXML = (promiseObj) => {\r\n  // Required as stated in §12.2\r\n  return new Promise((resolve, reject) => {\r\n\r\n    let xml = xmlbuilder.create(\r\n      'Relationships', {\r\n      'version': '1.0',\r\n      'encoding': 'UTF-8',\r\n      'standalone': true,\r\n      'allowSurrogateChars': true\r\n    }\r\n    )\r\n      .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\r\n\r\n    xml\r\n      .ele('Relationship')\r\n      .att('Id', `rId${promiseObj.wb.sheets.length + 1}`)\r\n      .att('Target', 'sharedStrings.xml')\r\n      .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings');\r\n\r\n    xml\r\n      .ele('Relationship')\r\n      .att('Id', `rId${promiseObj.wb.sheets.length + 2}`)\r\n      .att('Target', 'styles.xml')\r\n      .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles');\r\n\r\n    promiseObj.wb.sheets.forEach((s, i) => {\r\n      xml\r\n        .ele('Relationship')\r\n        .att('Id', `rId${i + 1}`)\r\n        .att('Target', `worksheets/sheet${i + 1}.xml`)\r\n        .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet');\r\n    });\r\n\r\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n    promiseObj.xlsx.folder('xl').folder('_rels').file('workbook.xml.rels', xmlString);\r\n    resolve(promiseObj);\r\n\r\n  });\r\n};\r\n\r\nlet addCorePropertiesXML = (promiseObj) => {\r\n  let xml = xmlbuilder.create(\r\n    'cp:coreProperties', {\r\n    'version': '1.0',\r\n    'encoding': 'UTF-8',\r\n    'standalone': true\r\n  }\r\n  )\r\n    .att('xmlns:cp', 'http://schemas.openxmlformats.org/package/2006/metadata/core-properties')\r\n    .att('xmlns:dc', 'http://purl.org/dc/elements/1.1/')\r\n    .att('xmlns:dcterms', 'http://purl.org/dc/terms/')\r\n    .att('xmlns:dcmitype', 'http://purl.org/dc/dcmitype/')\r\n    .att('xmlns:xsi', 'http://www.w3.org/2001/XMLSchema-instance');\r\n\r\n  xml.ele('dc:creator').text(promiseObj.wb.author);\r\n  xml.ele('cp:lastModifiedBy').text(promiseObj.wb.author);\r\n  let dtStr = new Date().toISOString();\r\n  xml.ele('dcterms:created').att('xsi:type', 'dcterms:W3CDTF').text(dtStr);\r\n  xml.ele('dcterms:modified').att('xsi:type', 'dcterms:W3CDTF').text(dtStr);\r\n  let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n  promiseObj.xlsx.folder('docProps').file('core.xml', xmlString);\r\n  return promiseObj;\r\n};\r\n\r\nlet addWorksheetsXML = (promiseObj) => {\r\n  // Required as stated in §12.2\r\n  return new Promise((resolve, reject) => {\r\n\r\n    let curSheet = 0;\r\n\r\n    let processNextSheet = () => {\r\n      let thisSheet = promiseObj.wb.sheets[curSheet];\r\n      if (thisSheet) {\r\n        curSheet++;\r\n        thisSheet.generateXML()\r\n          .then((xml) => {\r\n            return new Promise((resolve) => {\r\n              // Add worksheet to zip\r\n              promiseObj.xlsx.folder('xl').folder('worksheets').file(`sheet${curSheet}.xml`, xml);\r\n\r\n              resolve();\r\n            });\r\n          })\r\n          .then(() => {\r\n            return thisSheet.generateRelsXML();\r\n          })\r\n          .then((xml) => {\r\n            return new Promise((resolve) => {\r\n              if (xml) {\r\n                promiseObj.xlsx.folder('xl').folder('worksheets').folder('_rels').file(`sheet${curSheet}.xml.rels`, xml);\r\n              }\r\n              resolve();\r\n            });\r\n          })\r\n          .then(() => {\r\n            return thisSheet.generateCommentsXML();\r\n          })\r\n          .then((xml) => {\r\n            return new Promise((resolve) => {\r\n              if (xml) {\r\n                promiseObj.xlsx.folder('xl').file(`comments${curSheet}.xml`, xml);\r\n              }\r\n              resolve();\r\n            });\r\n          })\r\n          .then(() => {\r\n            return thisSheet.generateCommentsVmlXML();\r\n          })\r\n          .then((xml) => {\r\n            return new Promise((resolve) => {\r\n              if (xml) {\r\n                promiseObj.xlsx.folder('xl').folder('drawings').file(`commentsVml${curSheet}.vml`, xml);\r\n              }\r\n              resolve();\r\n            });\r\n          })\r\n          .then(processNextSheet)\r\n          .catch((e) => {\r\n            promiseObj.wb.logger.error(e.stack);\r\n          });\r\n      } else {\r\n        resolve(promiseObj);\r\n      }\r\n    };\r\n    processNextSheet();\r\n\r\n  });\r\n};\r\n\r\n/**\r\n * Generate XML for SharedStrings.xml file and add it to zip file. Called from _writeToBuffer()\r\n * @private\r\n * @memberof Workbook\r\n * @param {Object} promiseObj object containing jszip instance, workbook intance and xmlvars\r\n * @return {Promise} Resolves with promiseObj\r\n */\r\nlet addSharedStringsXML = (promiseObj) => {\r\n  // §12.3.15 Shared String Table Part\r\n  return new Promise((resolve, reject) => {\r\n\r\n    let xml = xmlbuilder.create(\r\n      'sst', {\r\n      'version': '1.0',\r\n      'encoding': 'UTF-8',\r\n      'standalone': true,\r\n      'allowSurrogateChars': true\r\n    }\r\n    )\r\n      .att('count', promiseObj.wb.sharedStrings.length)\r\n      .att('uniqueCount', promiseObj.wb.sharedStrings.length)\r\n      .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\r\n\r\n    promiseObj.wb.sharedStrings.forEach((s) => {\r\n      if (typeof s === 'string') {\r\n        xml.ele('si').ele('t').txt(s);\r\n      } else if (s instanceof Array) {\r\n\r\n        let thisSI = xml.ele('si');\r\n        let theseRuns = []; // §18.4.4 r (Rich Text Run)\r\n        let currProps = {};\r\n        let curRun;\r\n        let i = 0;\r\n        while (i < s.length) {\r\n          if (typeof s[i] === 'string') {\r\n            if (curRun === undefined) {\r\n              theseRuns.push({\r\n                props: {},\r\n                text: ''\r\n              });\r\n              curRun = theseRuns[theseRuns.length - 1];\r\n            }\r\n            curRun.text = curRun.text + s[i];\r\n          } else if (typeof s[i] === 'object') {\r\n            theseRuns.push({\r\n              props: {},\r\n              text: ''\r\n            });\r\n            curRun = theseRuns[theseRuns.length - 1];\r\n            Object.keys(s[i]).forEach((k) => {\r\n              currProps[k] = s[i][k];\r\n            });\r\n            Object.keys(currProps).forEach((k) => {\r\n              curRun.props[k] = currProps[k];\r\n            });\r\n            if (s[i].value !== undefined) {\r\n              curRun.text = s[i].value;\r\n            }\r\n          }\r\n          i++;\r\n        }\r\n\r\n        theseRuns.forEach((run) => {\r\n          if (Object.keys(run).length < 1) {\r\n            thisSI.ele('t', run.text).att('xml:space', 'preserve');\r\n          } else {\r\n            let thisRun = thisSI.ele('r');\r\n            let thisRunProps = thisRun.ele('rPr');\r\n            typeof run.props.name === 'string' ? thisRunProps.ele('rFont').att('val', run.props.name) : null;\r\n            run.props.bold === true ? thisRunProps.ele('b') : null;\r\n            run.props.italics === true ? thisRunProps.ele('i') : null;\r\n            run.props.strike === true ? thisRunProps.ele('strike') : null;\r\n            run.props.outline === true ? thisRunProps.ele('outline') : null;\r\n            run.props.shadow === true ? thisRunProps.ele('shadow') : null;\r\n            run.props.condense === true ? thisRunProps.ele('condense') : null;\r\n            run.props.extend === true ? thisRunProps.ele('extend') : null;\r\n            if (typeof run.props.color === 'string') {\r\n              let thisColor = new CTColor(run.props.color);\r\n              thisColor.addToXMLele(thisRunProps);\r\n            }\r\n            typeof run.props.size === 'number' ? thisRunProps.ele('sz').att('val', run.props.size) : null;\r\n            run.props.underline === true ? thisRunProps.ele('u') : null;\r\n            typeof run.props.vertAlign === 'string' ? thisRunProps.ele('vertAlign').att('val', run.props.vertAlign) : null;\r\n            thisRun.ele('t', run.text).att('xml:space', 'preserve');\r\n          }\r\n        });\r\n\r\n      }\r\n    });\r\n\r\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n    promiseObj.xlsx.folder('xl').file('sharedStrings.xml', xmlString);\r\n\r\n    resolve(promiseObj);\r\n\r\n  });\r\n};\r\n\r\nlet addStylesXML = (promiseObj) => {\r\n  // §12.3.20 Styles Part\r\n  return new Promise((resolve, reject) => {\r\n\r\n    let xml = xmlbuilder.create(\r\n      'styleSheet', {\r\n      'version': '1.0',\r\n      'encoding': 'UTF-8',\r\n      'standalone': true,\r\n      'allowSurrogateChars': true\r\n    }\r\n    )\r\n      .att('mc:Ignorable', 'x14ac')\r\n      .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main')\r\n      .att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006')\r\n      .att('xmlns:x14ac', 'http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac');\r\n\r\n    if (promiseObj.wb.styleData.numFmts.length > 0) {\r\n      let nfXML = xml\r\n        .ele('numFmts')\r\n        .att('count', promiseObj.wb.styleData.numFmts.length);\r\n      promiseObj.wb.styleData.numFmts.forEach((nf) => {\r\n        nf.addToXMLele(nfXML);\r\n      });\r\n    }\r\n\r\n    let fontXML = xml\r\n      .ele('fonts')\r\n      .att('count', promiseObj.wb.styleData.fonts.length);\r\n    promiseObj.wb.styleData.fonts.forEach((f) => {\r\n      f.addToXMLele(fontXML);\r\n    });\r\n\r\n    let fillXML = xml\r\n      .ele('fills')\r\n      .att('count', promiseObj.wb.styleData.fills.length);\r\n    promiseObj.wb.styleData.fills.forEach((f) => {\r\n      let fXML = fillXML.ele('fill');\r\n      f.addToXMLele(fXML);\r\n    });\r\n\r\n    let borderXML = xml\r\n      .ele('borders')\r\n      .att('count', promiseObj.wb.styleData.borders.length);\r\n    promiseObj.wb.styleData.borders.forEach((b) => {\r\n      b.addToXMLele(borderXML);\r\n    });\r\n\r\n\r\n    let cellXfsXML = xml\r\n      .ele('cellXfs')\r\n      .att('count', promiseObj.wb.styles.length);\r\n    promiseObj.wb.styles.forEach((s) => {\r\n      s.addXFtoXMLele(cellXfsXML);\r\n    });\r\n\r\n    if (promiseObj.wb.dxfCollection.length > 0) {\r\n      promiseObj.wb.dxfCollection.addToXMLele(xml);\r\n    }\r\n\r\n    let xmlString = xml.doc().end(promiseObj.xmlOutVars);\r\n    promiseObj.xlsx.folder('xl').file('styles.xml', xmlString);\r\n\r\n    resolve(promiseObj);\r\n  });\r\n};\r\n\r\nlet addDrawingsXML = (promiseObj) => {\r\n  return new Promise((resolve) => {\r\n    if (!promiseObj.wb.mediaCollection.isEmpty || !promiseObj.wb.chartsCollection.isEmpty) {\r\n\r\n      promiseObj.wb.sheets.forEach((ws) => {\r\n        if (!ws.drawingCollection.isEmpty) {\r\n\r\n          let drawingRelXML = xmlbuilder.create('Relationships', {\r\n            'version': '1.0',\r\n            'encoding': 'UTF-8',\r\n            'standalone': true,\r\n            'allowSurrogateChars': true\r\n          })\r\n            .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\r\n\r\n          let drawingsXML = xmlbuilder.create(\r\n            'xdr:wsDr', {\r\n            'version': '1.0',\r\n            'encoding': 'UTF-8',\r\n            'standalone': true,\r\n            'allowSurrogateChars': true\r\n          }\r\n          );\r\n          drawingsXML\r\n            .att('xmlns:a', 'http://schemas.openxmlformats.org/drawingml/2006/main')\r\n            .att('xmlns:xdr', 'http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing');\r\n\r\n          ws.drawingCollection.drawings.forEach((d) => {\r\n            if (d.kind === 'image') {\r\n              let target = 'image' + d.id + '.' + d.extension;\r\n\r\n              let image = d.imagePath ? fs.readFileSync(d.imagePath) : d.image;\r\n              promiseObj.xlsx.folder('xl').folder('media').file(target, image);\r\n\r\n              drawingRelXML.ele('Relationship')\r\n                .att('Id', d.rId)\r\n                .att('Target', '../media/' + target)\r\n                .att('Type', d.type);\r\n\r\n            }\r\n            if (d.kind == 'chart') {\r\n              let target = 'chart' + d.id + '.xml';\r\n              let chartBuilder = xmlbuilder.create('c:chartSpace', {\r\n                'version': '1.0', 'encoding': 'UTF-8', 'standalone': true\r\n              })\r\n                .att('xmlns:c', 'http://schemas.openxmlformats.org/drawingml/2006/chart')\r\n                .att('xmlns:a', 'http://schemas.openxmlformats.org/drawingml/2006/main')\r\n                .att('xmlns:r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships')\r\n                .att('xmlns:c16r2', 'http://schemas.microsoft.com/office/drawing/2015/06/chart');\r\n\r\n              d.chartPartXML(chartBuilder);\r\n              let chartXMLStr = chartBuilder.doc().end(promiseObj.xmlOutVars);\r\n              promiseObj.xlsx.folder('xl').folder('charts').file(target, chartXMLStr);\r\n              drawingRelXML.ele('Relationship')\r\n                .att('Id', d.rId)\r\n                .att('Target', '../charts/' + target)\r\n                .att('Type', d.type);\r\n\r\n            }\r\n            d.addToXMLele(drawingsXML);\r\n\r\n          });\r\n\r\n          let drawingsXMLStr = drawingsXML.doc().end(promiseObj.xmlOutVars);\r\n          let drawingRelXMLStr = drawingRelXML.doc().end(promiseObj.xmlOutVars);\r\n          promiseObj.xlsx.folder('xl').folder('drawings').file('drawing' + ws.sheetId + '.xml', drawingsXMLStr);\r\n          promiseObj.xlsx.folder('xl').folder('drawings').folder('_rels').file('drawing' + ws.sheetId + '.xml.rels', drawingRelXMLStr);\r\n        }\r\n      });\r\n\r\n    }\r\n    resolve(promiseObj);\r\n  });\r\n};\r\n\r\nlet addLegacyHeaderFooterDrawingsXML = (promiseObj) => {\r\n  return new Promise((resolve) => {\r\n    if (!promiseObj.wb.mediaCollection.isEmpty) {\r\n\r\n      promiseObj.wb.sheets.forEach((ws) => {\r\n\r\n        if (!ws.legacyDrawingHeaderFooter.isEmpty) {\r\n\r\n          let drawingRelXML = xmlbuilder.create('Relationships', {\r\n            'version': '1.0',\r\n            'encoding': 'UTF-8',\r\n            'standalone': true,\r\n            'allowSurrogateChars': true\r\n          })\r\n            .att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\r\n\r\n          let drawingsVML = xmlbuilder.begin().ele('xml');\r\n          drawingsVML.att('xmlns:v', 'urn:schemas-microsoft-com:vml')\r\n          drawingsVML.att('xmlns:o', 'urn:schemas-microsoft-com:office:office');\r\n          drawingsVML.att('xmlns:x', 'urn:schemas-microsoft-com:office:excel');\r\n\r\n          const sl = drawingsVML.ele('o:shapelayout').att('v:ext', 'edit');\r\n          sl.ele('o:idmap').att('v:ext', 'edit').att('data', ws.sheetId);\r\n\r\n          const st = drawingsVML.ele('v:shapetype')\r\n            .att('id', '_x0000_t75')\r\n            .att('coordsize', '21600,21600')\r\n            .att('o:spt', '75')\r\n            .att('o:preferrelative', 't')\r\n            .att('path', 'm@4@5l@4@11@9@11@9@5xe')\r\n            .att('filled', 'f').att('stroked', 'f');\r\n\r\n          st.ele('v:stroke').att('joinstyle', 'miter');\r\n          var vf = st.ele('v:formulas');\r\n          vf.ele('v:f').att('eqn', \"if lineDrawn pixelLineWidth 0\")\r\n          vf.ele('v:f').att('eqn', \"sum @0 1 0\");\r\n          vf.ele('v:f').att('eqn', \"sum 0 0 @1\");\r\n          vf.ele('v:f').att('eqn', \"prod @2 1 2\");\r\n          vf.ele('v:f').att('eqn', \"prod @3 21600 pixelWidth\");\r\n          vf.ele('v:f').att('eqn', \"prod @3 21600 pixelHeight\");\r\n          vf.ele('v:f').att('eqn', \"sum @0 0 1\");\r\n          vf.ele('v:f').att('eqn', \"prod @6 1 2\");\r\n          vf.ele('v:f').att('eqn', \"prod @7 21600 pixelWidth\");\r\n          vf.ele('v:f').att('eqn', \"sum @8 21600 0\");\r\n          vf.ele('v:f').att('eqn', \"prod @7 21600 pixelHeight\");\r\n          vf.ele('v:f').att('eqn', \"sum @10 21600 0\");\r\n\r\n          st.ele('v:path')\r\n            .att('o:extrusionok', 'f')\r\n            .att('gradientshapeok', 't')\r\n            .att('o:connecttype', 'rect')\r\n\r\n          st.ele('o:lock').att('v:ext', 'edit').att('aspectratio', 't');\r\n\r\n          // const sh = drawingsVML.ele('v:shape');\r\n          // sh.att('id','CF').att('o:spid','_x0000_s1025').att('type', '#_x0000_t75')\r\n          // .att('style',`position:absolute;margin-left:0;margin-top:0;width:510.75pt;height:45.75pt;z-index:1`);\r\n          // sh.ele('v:imagedata').att('o:relid','rId1').att('o:title','image1')\r\n          // sh.ele('o:lock').att('v:ext','edit').att('rotation','t');\r\n\r\n          // const textB = sh.ele('v:textbox').text('VML TextBox')\r\n\r\n          ws.legacyDrawingHeaderFooter.drawings.forEach((d) => {\r\n\r\n            if (d.kind === 'image') {\r\n              let target = 'image' + d.id + '.' + d.extension;\r\n\r\n              let image = d.imagePath ? fs.readFileSync(d.imagePath) : d.image;\r\n              promiseObj.xlsx.folder('xl').folder('media').file(target, image);\r\n\r\n              drawingRelXML.ele('Relationship')\r\n                .att('Id', d.rId)\r\n                .att('Target', '../media/' + target)\r\n                .att('Type', d.type);\r\n\r\n            }\r\n\r\n            d.addToXMLele(drawingsVML);\r\n\r\n          });\r\n\r\n          let drawingsXMLStr = drawingsVML.doc().end(promiseObj.xmlOutVars);\r\n          let drawingRelXMLStr = drawingRelXML.doc().end(promiseObj.xmlOutVars);\r\n          promiseObj.xlsx.folder('xl').folder('drawings').file('vmlDrawing' + ws.sheetId + '.vml', drawingsXMLStr);\r\n          promiseObj.xlsx.folder('xl').folder('drawings').folder('_rels').file('vmlDrawing' + ws.sheetId + '.vml.rels', drawingRelXMLStr);\r\n        }\r\n      });\r\n\r\n    }\r\n    resolve(promiseObj);\r\n  });\r\n};\r\n\r\n\r\n/**\r\n * Use JSZip to generate file to a node buffer\r\n * @private\r\n * @memberof Workbook\r\n * @param {Workbook} wb Workbook instance\r\n * @return {Promise} resolves with Buffer\r\n */\r\nlet writeToBuffer = (wb) => {\r\n  return new Promise((resolve, reject) => {\r\n    let promiseObj = {\r\n      wb: wb,\r\n      xlsx: new JSZip(),\r\n      xmlOutVars: {}\r\n    };\r\n\r\n    if (promiseObj.wb.sheets.length === 0) {\r\n      promiseObj.wb.Worksheet();\r\n    }\r\n\r\n    addRootContentTypesXML(promiseObj)\r\n      .then(addWorksheetsXML)\r\n      .then(addRootRelsXML)\r\n      .then(addWorkbookXML)\r\n      .then(addWorkbookRelsXML)\r\n      .then(addCorePropertiesXML)\r\n      .then(addSharedStringsXML)\r\n      .then(addStylesXML)\r\n      .then(addDrawingsXML)\r\n      .then(addLegacyHeaderFooterDrawingsXML)\r\n      .then(() => {\r\n        wb.opts.jszip.type = 'nodebuffer';\r\n        promiseObj.xlsx.generateAsync(wb.opts.jszip)\r\n          .then((buf) => {\r\n            resolve(buf);\r\n          })\r\n          .catch((e) => {\r\n            reject(e);\r\n          });\r\n      })\r\n      .catch((e) => {\r\n        reject(e);\r\n      });\r\n\r\n  });\r\n};\r\n\r\n/**\r\n * @desc Currently only used for testing the XML generated for a Workbook.\r\n * @param {*} wb Workbook instance\r\n * @return {Promise} resolves with Workbook XML\r\n */\r\nlet workbookXML = (wb) => {\r\n  let promiseObj = {\r\n    wb: wb,\r\n    xlsx: new JSZip(),\r\n    xmlOutVars: {}\r\n  };\r\n\r\n  return addWorkbookXML(promiseObj).then((result) => {\r\n    return result.xlsx.files['xl/workbook.xml']._data;\r\n  });\r\n}\r\n\r\nmodule.exports = {\r\n  writeToBuffer,\r\n  workbookXML\r\n};"]}