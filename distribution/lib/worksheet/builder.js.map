{"version":3,"sources":["../../../source/lib/worksheet/builder.js"],"names":["xml","require","utils","types","hyperlinks","Picture","_addSheetPr","promiseObj","Promise","resolve","reject","o","ws","opts","pageSetup","fitToHeight","fitToWidth","outline","summaryBelow","summaryRight","autoFilter","ref","ele","att","outlineEle","up","_addDimension","firstCell","lastCell","getExcelAlpha","lastUsedCol","lastUsedRow","_addSheetViews","sheetView","sv","showGridLines","workbookViewId","rightToLeft","zoomScale","zoomScaleNormal","zoomScalePageLayoutView","modifiedPaneParams","Object","keys","pane","forEach","k","push","length","pEle","xSplit","ySplit","topLeftCell","activePane","state","_addSheetFormatPr","sheetFormat","baseColWidth","defaultColWidth","defaultRowHeight","thickBottom","boolToInt","thickTop","_addCols","columnCount","colsEle","colId","cols","col","colEle","min","max","width","style","hidden","customWidth","outlineLevel","collapsed","_addSheetData","rows","processRows","theseRows","r","thisRow","cellRefs","sort","sortCellRefs","rEle","disableRowSpansOptimization","spans","s","customFormat","ht","customHeight","thickBot","i","cells","addToXMLele","processNextRows","splice","_addSheetProtection","sheetProtection","includeSheetProtection","sheet","objects","scenarios","getHashOfPassword","_addAutoFilter","startRow","filterRow","startCol","endCol","endRow","firstEmptyRow","undefined","curRow","firstColumn","lastColumn","startCell","endCell","wb","definedNameCollection","addDefinedName","localSheetId","name","refFormula","_addMergeCells","mergedCells","Array","cr","_addConditionalFormatting","cfRulesCollection","_addHyperlinks","hyperlinkCollection","_addDataValidations","dataValidationCollection","_addPrintOptions","addPrintOptions","printOptions","poEle","centerHorizontal","centerVertical","printHeadings","printGridLines","_addPageMargins","margins","left","right","top","bottom","header","footer","_addLegacyDrawing","rId","relationships","indexOf","_addPageSetup","addPageSetup","psEle","paperSize","paperHeight","paperWidth","scale","firstPageNumber","pageOrder","orientation","usePrinterDefaults","blackAndWhite","draft","cellComments","useFirstPageNumber","errors","horizontalDpi","verticalDpi","copies","_addPageBreaks","rowBreaks","pageBreaks","row","rbEle","bEle","pos","colBreaks","column","cbEle","_addHeaderFooter","addHeaderFooter","headerFooter","hfEle","alignWithMargins","differentFirst","differentOddEven","scaleWithDoc","oddHeader","text","oddFooter","evenHeader","evenFooter","firstHeader","firstFooter","_addlegacyDrawingHeaderFooter","legacyDrawingHeaderFooter","isEmpty","dId","_addDrawing","drawingCollection","sheetXML","xmlProlog","xmlString","wsXML","begin","chunk","then","end","catch","e","Error","stack","relsXML","sheetRelRequired","relXML","create","Hyperlink","location","sheetId","doc","commentsXML","commentsXml","author","commentList","comments","uuid","comment","commentsVmlXML","vmlXml","sl","st","position","marginLeft","marginTop","height","zIndex","visibility","fillColor","shape","tb","cd","module","exports"],"mappings":"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","file":"builder.js","sourcesContent":["const xml = require('xmlbuilder');\r\nconst utils = require('../utils.js');\r\nconst types = require('../types/index.js');\r\nconst hyperlinks = require('./classes/hyperlink');\r\nconst Picture = require('../drawing/picture.js');\r\n\r\nlet _addSheetPr = (promiseObj) => {\r\n    // §18.3.1.82 sheetPr (Sheet Properties)\r\n    return new Promise((resolve, reject) => {\r\n        let o = promiseObj.ws.opts;\r\n\r\n        // Check if any option that would require the sheetPr element to be added exists\r\n        if (\r\n            o.pageSetup.fitToHeight !== null ||\r\n            o.pageSetup.fitToWidth !== null ||\r\n            o.outline.summaryBelow !== null ||\r\n            o.outline.summaryRight !== null ||\r\n            o.autoFilter.ref !== null\r\n        ) {\r\n            let ele = promiseObj.xml.ele('sheetPr');\r\n\r\n            if (o.autoFilter.ref) {\r\n                ele.att('enableFormatConditionsCalculation', 1);\r\n                ele.att('filterMode', 1);\r\n            }\r\n\r\n            if (o.outline.summaryBelow !== null || o.outline.summaryRight !== null) {\r\n                let outlineEle = ele.ele('outlinePr');\r\n                outlineEle.att('applyStyles', 1);\r\n                outlineEle.att('summaryBelow',  o.outline.summaryBelow === true ? 1 : 0);\r\n                outlineEle.att('summaryRight',  o.outline.summaryRight === true ? 1 : 0);\r\n                outlineEle.up();\r\n            }\r\n\r\n            // §18.3.1.65 pageSetUpPr (Page Setup Properties)\r\n            if (o.pageSetup.fitToHeight !== null || o.pageSetup.fitToWidth !== null) {\r\n                ele.ele('pageSetUpPr').att('fitToPage', 1).up();\r\n            }\r\n            ele.up();\r\n        }\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addDimension = (promiseObj) => {\r\n    // §18.3.1.35 dimension (Worksheet Dimensions)\r\n    return new Promise((resolve, reject) => {\r\n        let firstCell = 'A1';\r\n        let lastCell = `${utils.getExcelAlpha(promiseObj.ws.lastUsedCol)}${promiseObj.ws.lastUsedRow}`;\r\n        let ele = promiseObj.xml.ele('dimension');\r\n        ele.att('ref', `${firstCell}:${lastCell}`);\r\n        ele.up();\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addSheetViews = (promiseObj) => {\r\n    // §18.3.1.88 sheetViews (Sheet Views)\r\n    return new Promise((resolve, reject) => {\r\n        let o = promiseObj.ws.opts.sheetView;\r\n        let ele = promiseObj.xml.ele('sheetViews');\r\n        let sv = ele.ele('sheetView')\r\n        .att('showGridLines', o.showGridLines)\r\n        .att('workbookViewId', o.workbookViewId)\r\n        .att('rightToLeft', o.rightToLeft)\r\n        .att('zoomScale', o.zoomScale)\r\n        .att('zoomScaleNormal', o.zoomScaleNormal)\r\n        .att('zoomScalePageLayoutView', o.zoomScalePageLayoutView);\r\n\r\n        let modifiedPaneParams = [];\r\n        Object.keys(o.pane).forEach((k) => {\r\n            if (o.pane[k] !== null) {\r\n                modifiedPaneParams.push(k);\r\n            }\r\n        });\r\n        if (modifiedPaneParams.length > 0) {\r\n            let pEle = sv.ele('pane');\r\n            o.pane.xSplit !== null ? pEle.att('xSplit', o.pane.xSplit) : null;\r\n            o.pane.ySplit !== null ? pEle.att('ySplit', o.pane.ySplit) : null;\r\n            o.pane.topLeftCell !== null ? pEle.att('topLeftCell', o.pane.topLeftCell) : null;\r\n            o.pane.activePane !== null ? pEle.att('activePane', o.pane.activePane) : null;\r\n            o.pane.state !== null ? pEle.att('state', o.pane.state) : null;\r\n            pEle.up();\r\n        }\r\n        sv.up();\r\n        ele.up();\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addSheetFormatPr = (promiseObj) => {\r\n    // §18.3.1.81 sheetFormatPr (Sheet Format Properties)\r\n    return new Promise((resolve, reject) => {\r\n        let o = promiseObj.ws.opts.sheetFormat;\r\n        let ele = promiseObj.xml.ele('sheetFormatPr');\r\n\r\n        o.baseColWidth !== null ? ele.att('baseColWidth', o.baseColWidth) : null;\r\n        o.defaultColWidth !== null ? ele.att('defaultColWidth', o.defaultColWidth) : null;\r\n        o.defaultRowHeight !== null ? ele.att('defaultRowHeight', o.defaultRowHeight) : ele.att('defaultRowHeight', 16);\r\n        o.thickBottom !== null ? ele.att('thickBottom', utils.boolToInt(o.thickBottom)) : null;\r\n        o.thickTop !== null ? ele.att('thickTop', utils.boolToInt(o.thickTop)) : null;\r\n\r\n\r\n        if (typeof o.defaultRowHeight === 'number') {\r\n            ele.att('customHeight', '1');\r\n        }\r\n        ele.up();\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addCols = (promiseObj) => {\r\n    // §18.3.1.17 cols (Column Information)\r\n    return new Promise((resolve, reject) => {\r\n\r\n        if (promiseObj.ws.columnCount > 0) {\r\n            let colsEle = promiseObj.xml.ele('cols');\r\n\r\n            for (let colId in promiseObj.ws.cols) {\r\n                let col = promiseObj.ws.cols[colId];\r\n                let colEle = colsEle.ele('col');\r\n\r\n                col.min !== null ? colEle.att('min', col.min) : null;\r\n                col.max !== null ? colEle.att('max', col.max) : null;\r\n                col.width !== null ? colEle.att('width', col.width) : null;\r\n                col.style !== null ? colEle.att('style', col.style) : null;\r\n                col.hidden !== null ? colEle.att('hidden', utils.boolToInt(col.hidden)) : null;\r\n                col.customWidth !== null ? colEle.att('customWidth', utils.boolToInt(col.customWidth)) : null;\r\n                col.outlineLevel !== null ? colEle.att('outlineLevel', col.outlineLevel) : null;\r\n                col.collapsed !== null ? colEle.att('collapsed', utils.boolToInt(col.collapsed)) : null;\r\n                colEle.up();\r\n            }\r\n            colsEle.up();\r\n        }\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addSheetData = (promiseObj) => {\r\n    // §18.3.1.80 sheetData (Sheet Data)\r\n    return new Promise((resolve, reject) => {\r\n\r\n        let ele = promiseObj.xml.ele('sheetData');\r\n        let rows = Object.keys(promiseObj.ws.rows);\r\n\r\n        let processRows = (theseRows) => {\r\n            for (var r = 0; r < theseRows.length; r++) {\r\n                let thisRow = promiseObj.ws.rows[theseRows[r]];\r\n                thisRow.cellRefs.sort(utils.sortCellRefs);\r\n\r\n                let rEle = ele.ele('row');\r\n\r\n                rEle.att('r', thisRow.r);\r\n                if (promiseObj.ws.opts.disableRowSpansOptimization !== true && thisRow.spans) {\r\n                    rEle.att('spans', thisRow.spans);\r\n                }\r\n                thisRow.s !== null ? rEle.att('s', thisRow.s) : null;\r\n                thisRow.customFormat !== null ? rEle.att('customFormat', thisRow.customFormat) : null;\r\n                thisRow.ht !== null ? rEle.att('ht', thisRow.ht) : null;\r\n                thisRow.hidden !== null ? rEle.att('hidden', thisRow.hidden) : null;\r\n                thisRow.customHeight === true || typeof promiseObj.ws.opts.sheetFormat.defaultRowHeight === 'number' ? rEle.att('customHeight', 1) : null;\r\n                thisRow.outlineLevel !== null ? rEle.att('outlineLevel', thisRow.outlineLevel) : null;\r\n                thisRow.collapsed !== null ? rEle.att('collapsed', thisRow.collapsed) : null;\r\n                thisRow.thickTop !== null ? rEle.att('thickTop', thisRow.thickTop) : null;\r\n                thisRow.thickBot !== null ? rEle.att('thickBot', thisRow.thickBot) : null;\r\n\r\n                for (var i = 0; i < thisRow.cellRefs.length; i++) {\r\n                    promiseObj.ws.cells[thisRow.cellRefs[i]].addToXMLele(rEle);\r\n                }\r\n\r\n                rEle.up();\r\n            }\r\n\r\n            processNextRows();\r\n        };\r\n\r\n        let processNextRows = () => {\r\n            let theseRows = rows.splice(0, 500);\r\n            if (theseRows.length === 0) {\r\n                ele.up();\r\n                return resolve(promiseObj);\r\n            }\r\n            processRows(theseRows);\r\n        };\r\n\r\n        processNextRows();\r\n\r\n    });\r\n};\r\n\r\nlet _addSheetProtection = (promiseObj) => {\r\n    // §18.3.1.85 sheetProtection (Sheet Protection Options)\r\n    return new Promise((resolve, reject) => {\r\n        let o = promiseObj.ws.opts.sheetProtection;\r\n        let includeSheetProtection = false;\r\n        Object.keys(o).forEach((k) =>  {\r\n            if (o[k] !== null) {\r\n                includeSheetProtection = true;\r\n            }\r\n        });\r\n\r\n        if (includeSheetProtection) {\r\n            // Set required fields with defaults if not specified\r\n            o.sheet = o.sheet !== null ? o.sheet : true;\r\n            o.objects = o.objects !== null ? o.objects : true;\r\n            o.scenarios = o.scenarios !== null ? o.scenarios : true;\r\n\r\n            let ele = promiseObj.xml.ele('sheetProtection');\r\n            Object.keys(o).forEach((k) => {\r\n                if (o[k] !== null) {\r\n                    if (k === 'password') {\r\n                        ele.att('password', utils.getHashOfPassword(o[k]));\r\n                    } else {\r\n                        ele.att(k, utils.boolToInt(o[k]));\r\n                    }\r\n                }\r\n            });\r\n            ele.up();\r\n        }\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addAutoFilter = (promiseObj) => {\r\n    // §18.3.1.2 autoFilter (AutoFilter Settings)\r\n    return new Promise((resolve, reject) => {\r\n        let o = promiseObj.ws.opts.autoFilter;\r\n\r\n        if (typeof o.startRow === 'number') {\r\n            let ele = promiseObj.xml.ele('autoFilter');\r\n            let filterRow = promiseObj.ws.rows[o.startRow];\r\n\r\n            o.startCol = typeof o.startCol === 'number' ? o.startCol : null;\r\n            o.endCol = typeof o.endCol === 'number' ? o.endCol : null;\r\n\r\n            if (typeof o.endRow !== 'number') {\r\n                let firstEmptyRow = undefined;\r\n                let curRow = o.startRow;\r\n                while (firstEmptyRow === undefined) {\r\n                    if (!promiseObj.ws.rows[curRow]) {\r\n                        firstEmptyRow = curRow;\r\n                    } else {\r\n                        curRow++;\r\n                    }\r\n                }\r\n\r\n                o.endRow = firstEmptyRow - 1;\r\n            }\r\n\r\n            // Columns to sort not manually set. filter all columns in this row containing data.\r\n            if (typeof o.startCol !== 'number' || typeof o.endCol !== 'number') {\r\n                o.startCol = filterRow.firstColumn;\r\n                o.endCol = filterRow.lastColumn;\r\n            }\r\n\r\n            let startCell = utils.getExcelAlpha(o.startCol) + o.startRow;\r\n            let endCell = utils.getExcelAlpha(o.endCol) + o.endRow;\r\n\r\n            ele.att('ref', `${startCell}:${endCell}`);\r\n            promiseObj.ws.wb.definedNameCollection.addDefinedName({\r\n                hidden: 1,\r\n                localSheetId: promiseObj.ws.localSheetId,\r\n                name: '_xlnm._FilterDatabase',\r\n                refFormula: '\\'' + promiseObj.ws.name + '\\'!' +\r\n                    '$' + utils.getExcelAlpha(o.startCol) +\r\n                    '$' + o.startRow +\r\n                    ':' +\r\n                    '$' + utils.getExcelAlpha(o.endCol) +\r\n                    '$' + o.endRow\r\n            });\r\n            ele.up();\r\n        }\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addMergeCells = (promiseObj) => {\r\n    // §18.3.1.55 mergeCells (Merge Cells)\r\n    return new Promise((resolve, reject) => {\r\n\r\n        if (promiseObj.ws.mergedCells instanceof Array && promiseObj.ws.mergedCells.length > 0) {\r\n            let ele = promiseObj.xml.ele('mergeCells').att('count', promiseObj.ws.mergedCells.length);\r\n            promiseObj.ws.mergedCells.forEach((cr) => {\r\n                ele.ele('mergeCell').att('ref', cr).up();\r\n            });\r\n            ele.up();\r\n        }\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addConditionalFormatting = (promiseObj) => {\r\n    // §18.3.1.18 conditionalFormatting (Conditional Formatting)\r\n    return new Promise((resolve, reject) => {\r\n        promiseObj.ws.cfRulesCollection.addToXMLele(promiseObj.xml);\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addHyperlinks = (promiseObj) => {\r\n    // §18.3.1.48 hyperlinks (Hyperlinks)\r\n    return new Promise((resolve, reject) => {\r\n        promiseObj.ws.hyperlinkCollection.addToXMLele(promiseObj.xml);\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addDataValidations = (promiseObj) => {\r\n    // §18.3.1.33 dataValidations (Data Validations)\r\n    return new Promise((resolve, reject) => {\r\n        if (promiseObj.ws.dataValidationCollection.length > 0) {\r\n            promiseObj.ws.dataValidationCollection.addToXMLele(promiseObj.xml);\r\n        }\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addPrintOptions = (promiseObj) => {\r\n    // §18.3.1.70 printOptions (Print Options)\r\n    return new Promise((resolve, reject) => {\r\n\r\n        let addPrintOptions = false;\r\n        let o = promiseObj.ws.opts.printOptions;\r\n        Object.keys(o).forEach((k) => {\r\n            if (o[k] !== null) {\r\n                addPrintOptions = true;\r\n            }\r\n        });\r\n\r\n        if (addPrintOptions) {\r\n            let poEle = promiseObj.xml.ele('printOptions');\r\n            o.centerHorizontal === true ? poEle.att('horizontalCentered', 1) : null;\r\n            o.centerVertical === true ? poEle.att('verticalCentered', 1) : null;\r\n            o.printHeadings === true ? poEle.att('headings', 1) : null;\r\n            if (o.printGridLines === true) {\r\n                poEle.att('gridLines', 1);\r\n                poEle.att('gridLinesSet', 1);\r\n            }\r\n            poEle.up();\r\n        }\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addPageMargins = (promiseObj) => {\r\n    // §18.3.1.62 pageMargins (Page Margins)\r\n    return new Promise((resolve, reject) => {\r\n        let o = promiseObj.ws.opts.margins;\r\n\r\n        promiseObj.xml.ele('pageMargins')\r\n        .att('left', o.left)\r\n        .att('right', o.right)\r\n        .att('top', o.top)\r\n        .att('bottom', o.bottom)\r\n        .att('header', o.header)\r\n        .att('footer', o.footer)\r\n        .up();\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addLegacyDrawing = (promiseObj) => {\r\n    return new Promise((resolve, reject) => {\r\n\r\n        const rId = promiseObj.ws.relationships.indexOf('commentsVml') + 1;\r\n        if(rId === 0) {\r\n            resolve(promiseObj);\r\n        } else {\r\n            promiseObj.xml.ele('legacyDrawing')\r\n            .att('r:id', 'rId' + rId)\r\n            .up();\r\n\r\n            resolve(promiseObj);\r\n        }\r\n    })\r\n}\r\n\r\nlet _addPageSetup = (promiseObj) => {\r\n    // §18.3.1.63 pageSetup (Page Setup Settings)\r\n    return new Promise((resolve, reject) => {\r\n\r\n        let addPageSetup = false;\r\n        let o = promiseObj.ws.opts.pageSetup;\r\n        Object.keys(o).forEach((k) => {\r\n            if (o[k] !== null) {\r\n                addPageSetup = true;\r\n            }\r\n        });\r\n\r\n        if (addPageSetup === true) {\r\n            let psEle = promiseObj.xml.ele('pageSetup');\r\n            o.paperSize !== null ? psEle.att('paperSize', types.paperSize[o.paperSize]) : null;\r\n            o.paperHeight !== null ? psEle.att('paperHeight', o.paperHeight) : null;\r\n            o.paperWidth !== null ? psEle.att('paperWidth', o.paperWidth) : null;\r\n            o.scale !== null ? psEle.att('scale', o.scale) : null;\r\n            o.firstPageNumber !== null ? psEle.att('firstPageNumber', o.firstPageNumber) : null;\r\n            o.fitToWidth !== null ? psEle.att('fitToWidth', o.fitToWidth) : null;\r\n            o.fitToHeight !== null ? psEle.att('fitToHeight', o.fitToHeight) : null;\r\n            o.pageOrder !== null ? psEle.att('pageOrder', o.pageOrder) : null;\r\n            o.orientation !== null ? psEle.att('orientation', o.orientation) : null;\r\n            o.usePrinterDefaults !== null ? psEle.att('usePrinterDefaults', utils.boolToInt(o.usePrinterDefaults)) : null;\r\n            o.blackAndWhite !== null ? psEle.att('blackAndWhite', utils.boolToInt(o.blackAndWhite)) : null;\r\n            o.draft !== null ? psEle.att('draft', utils.boolToInt(o.draft)) : null;\r\n            o.cellComments !== null ? psEle.att('cellComments', o.cellComments) : null;\r\n            o.useFirstPageNumber !== null ? psEle.att('useFirstPageNumber', utils.boolToInt(o.useFirstPageNumber)) : null;\r\n            o.errors !== null ? psEle.att('errors', o.errors) : null;\r\n            o.horizontalDpi !== null ? psEle.att('horizontalDpi', o.horizontalDpi) : null;\r\n            o.verticalDpi !== null ? psEle.att('verticalDpi', o.verticalDpi) : null;\r\n            o.copies !== null ? psEle.att('copies', o.copies) : null;\r\n            psEle.up();\r\n        }\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addPageBreaks = (promiseObj) => {\r\n    // colBreaks (§18.3.1.14); rowBreaks (§18.3.1.74)\r\n    const rowBreaks = promiseObj.ws.pageBreaks.row;\r\n    if (rowBreaks.length > 0) {\r\n        const rbEle = promiseObj.xml.ele('rowBreaks');\r\n        rbEle.att('count', rowBreaks.length);\r\n        rbEle.att('manualBreakCount', rowBreaks.length);\r\n        rowBreaks.forEach(pos => {\r\n            const bEle = rbEle.ele('brk');\r\n            bEle.att('id', pos);\r\n            bEle.att('man', 1);\r\n            bEle.up();\r\n        });\r\n        rbEle.up();\r\n    }\r\n    const colBreaks = promiseObj.ws.pageBreaks.column;\r\n    if (colBreaks.length > 0) {\r\n        const cbEle = promiseObj.xml.ele('colBreaks');\r\n        cbEle.att('count', colBreaks.length);\r\n        cbEle.att('manualBreakCount', colBreaks.length);\r\n        colBreaks.forEach(pos => {\r\n            const bEle = cbEle.ele('brk');\r\n            bEle.att('id', pos);\r\n            bEle.att('man', 1);\r\n            bEle.up();\r\n        });\r\n        cbEle.up();\r\n    }\r\n    return promiseObj;\r\n}\r\n\r\nlet _addHeaderFooter = (promiseObj) => {\r\n    // §18.3.1.46 headerFooter (Header Footer Settings)\r\n    return new Promise((resolve, reject) => {\r\n\r\n        let addHeaderFooter = false;\r\n        let o = promiseObj.ws.opts.headerFooter;\r\n        Object.keys(o).forEach((k) => {\r\n            if (o[k] !== null) {\r\n                addHeaderFooter = true;\r\n            }\r\n        });\r\n\r\n        if (addHeaderFooter === true) {\r\n            let hfEle = promiseObj.xml.ele('headerFooter');\r\n\r\n            o.alignWithMargins !== null ? hfEle.att('alignWithMargins', utils.boolToInt(o.alignWithMargins)) : null;\r\n            o.differentFirst !== null ? hfEle.att('differentFirst', utils.boolToInt(o.differentFirst)) : null;\r\n            o.differentOddEven !== null ? hfEle.att('differentOddEven', utils.boolToInt(o.differentOddEven)) : null;\r\n            o.scaleWithDoc !== null ? hfEle.att('scaleWithDoc', utils.boolToInt(o.scaleWithDoc)) : null;\r\n\r\n            o.oddHeader !== null ? hfEle.ele('oddHeader').text(o.oddHeader).up() : null;\r\n            o.oddFooter !== null ? hfEle.ele('oddFooter').text(o.oddFooter).up() : null;\r\n            o.evenHeader !== null ? hfEle.ele('evenHeader').text(o.evenHeader).up() : null;\r\n            o.evenFooter !== null ? hfEle.ele('evenFooter').text(o.evenFooter).up() : null;\r\n            o.firstHeader !== null ? hfEle.ele('firstHeader').text(o.firstHeader).up() : null;\r\n            o.firstFooter !== null ? hfEle.ele('firstFooter').text(o.firstFooter).up() : null;\r\n            hfEle.up();\r\n        }\r\n\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addlegacyDrawingHeaderFooter = (promiseObj) => {\r\n    return new Promise((resolve, reject) => {\r\n        if (!promiseObj.ws.legacyDrawingHeaderFooter.isEmpty) {\r\n            let dId = promiseObj.ws.relationships.indexOf('legacyDrawingHeaderFooter') + 1;\r\n            promiseObj.xml.ele('legacyDrawingHF').att('r:id', 'rId' + dId).up();\r\n        }\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet _addDrawing = (promiseObj) => {\r\n    // §18.3.1.36 drawing (Drawing)\r\n    return new Promise((resolve, reject) => {\r\n        if (!promiseObj.ws.drawingCollection.isEmpty) {\r\n            let dId = promiseObj.ws.relationships.indexOf('drawing') + 1;\r\n            promiseObj.xml.ele('drawing').att('r:id', 'rId' + dId).up();\r\n        }\r\n        resolve(promiseObj);\r\n    });\r\n};\r\n\r\nlet sheetXML = (ws) => {\r\n    return new Promise((resolve, reject) => {\r\n\r\n        let xmlProlog = '<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>';\r\n        let xmlString = '';\r\n        let wsXML = xml.begin({\r\n          'allowSurrogateChars': true,\r\n        }, (chunk) => {\r\n            xmlString += chunk;\r\n        })\r\n\r\n        .ele('worksheet')\r\n        .att('mc:Ignorable', 'x14ac')\r\n        .att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main')\r\n        .att('xmlns:mc', 'http://schemas.openxmlformats.org/markup-compatibility/2006')\r\n        .att('xmlns:r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships')\r\n        .att('xmlns:x14ac', 'http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac');\r\n\r\n        // Excel complains if specific elements on not in the correct order in the XML doc as defined in §M.2.2\r\n        let promiseObj = { xml: wsXML, ws: ws };\r\n\r\n        _addSheetPr(promiseObj)\r\n        .then(_addDimension)\r\n        .then(_addSheetViews)\r\n        .then(_addSheetFormatPr)\r\n        .then(_addCols)\r\n        .then(_addSheetData)\r\n        .then(_addSheetProtection)\r\n        .then(_addAutoFilter)\r\n        .then(_addMergeCells)\r\n        .then(_addConditionalFormatting)\r\n        .then(_addDataValidations)\r\n        .then(_addHyperlinks)\r\n        .then(_addPrintOptions)\r\n        .then(_addPageMargins)\r\n        .then(_addLegacyDrawing)\r\n        .then(_addPageSetup)\r\n        .then(_addPageBreaks)\r\n        .then(_addHeaderFooter)\r\n        .then(_addlegacyDrawingHeaderFooter)\r\n        .then(_addDrawing)\r\n        .then((promiseObj) => {\r\n            return new Promise((resolve, reject) => {\r\n                wsXML.end();\r\n                resolve(xmlString);\r\n            });\r\n        })\r\n        .then((xml) => {\r\n            resolve(xml);\r\n        })\r\n        .catch((e) => {\r\n            throw new Error(e.stack);\r\n        });\r\n    });\r\n};\r\n\r\nlet relsXML = (ws) => {\r\n    return new Promise((resolve, reject) => {\r\n        let sheetRelRequired = false;\r\n        if (ws.relationships.length > 0) {\r\n            sheetRelRequired = true;\r\n        }\r\n\r\n        if (sheetRelRequired === false) {\r\n            resolve();\r\n        }\r\n\r\n        let relXML = xml.create(\r\n            'Relationships',\r\n            {\r\n                'version': '1.0',\r\n                'encoding': 'UTF-8',\r\n                'standalone': true,\r\n                'allowSurrogateChars': true\r\n            }\r\n        );\r\n        relXML.att('xmlns', 'http://schemas.openxmlformats.org/package/2006/relationships');\r\n\r\n        ws.relationships.forEach((r, i) => {\r\n            let rId = 'rId' + (i + 1);\r\n            if (r instanceof hyperlinks.Hyperlink) {\r\n                relXML.ele('Relationship')\r\n                .att('Id', rId)\r\n                .att('Target', r.location)\r\n                .att('TargetMode', 'External')\r\n                .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink');\r\n            } else if (r === 'drawing') {\r\n                relXML.ele('Relationship')\r\n                .att('Id', rId)\r\n                .att('Target', '../drawings/drawing' + ws.sheetId + '.xml')\r\n                .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/drawing');\r\n            } else if (r === 'comments') {\r\n                relXML.ele('Relationship')\r\n                .att('Id', rId)\r\n                .att('Target', '../comments' + ws.sheetId + '.xml')\r\n                .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/comments');\r\n            } else if (r === 'commentsVml') {\r\n                relXML.ele('Relationship')\r\n                .att('Id', rId)\r\n                .att('Target', '../drawings/commentsVml' + ws.sheetId + '.vml')\r\n                    .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/vmlDrawing');\r\n            } else if (r === 'legacyDrawingHeaderFooter') {\r\n                relXML.ele('Relationship')\r\n                    .att('Id', rId)\r\n                    .att('Target', '../drawings/vmlDrawing' + ws.sheetId + '.vml')\r\n                    .att('Type', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/vmlDrawing');\r\n            }\r\n        });\r\n        let xmlString = relXML.doc().end();\r\n        resolve(xmlString);\r\n    });\r\n};\r\n\r\nlet commentsXML = (ws) => {\r\n    return new Promise((resolve, reject) => {\r\n        const commentsXml = xml.create(\r\n            'comments',\r\n            {\r\n                'version': '1.0',\r\n                'encoding': 'UTF-8',\r\n                'standalone': true,\r\n                'allowSurrogateChars': true\r\n            }\r\n        );\r\n        commentsXml.att('xmlns', 'http://schemas.openxmlformats.org/spreadsheetml/2006/main');\r\n\r\n        commentsXml.ele('authors').ele('author').text(ws.wb.author);\r\n\r\n        const commentList = commentsXml.ele('commentList');\r\n        Object.keys(ws.comments).forEach(ref => {\r\n            commentList\r\n                .ele('comment')\r\n                .att('ref', ref)\r\n                .att('authorId', '0')\r\n                .att('guid', ws.comments[ref].uuid)\r\n                .ele('text')\r\n                .ele('t')\r\n                .text(ws.comments[ref].comment);\r\n        });\r\n        let xmlString = commentsXml.doc().end();\r\n        resolve(xmlString);\r\n    });\r\n}\r\n\r\nlet commentsVmlXML = (ws) => {\r\n    return new Promise((resolve, reject) => {\r\n        // do not add XML prolog to document\r\n        const vmlXml = xml.begin().ele('xml');\r\n        vmlXml.att('xmlns:v', 'urn:schemas-microsoft-com:vml')\r\n        vmlXml.att('xmlns:o', 'urn:schemas-microsoft-com:office:office');\r\n        vmlXml.att('xmlns:x', 'urn:schemas-microsoft-com:office:excel');\r\n\r\n        const sl = vmlXml.ele('o:shapelayout').att('v:ext', 'edit');\r\n        sl.ele('o:idmap').att('v:ext', 'edit').att('data', ws.sheetId);\r\n\r\n        const st = vmlXml.ele('v:shapetype')\r\n            .att('id', '_x0000_t202')\r\n            .att('coordsize', '21600,21600')\r\n            .att('o:spt', '202')\r\n            .att('path', 'm,l,21600r21600,l21600,xe');\r\n        st.ele('v:stroke').att('joinstyle', 'miter');\r\n        st.ele('v:path').att('gradientshapeok', 't').att('o:connecttype', 'rect');\r\n\r\n        Object.keys(ws.comments).forEach((ref) => {\r\n            const {row, col, position, marginLeft, marginTop, width, height, zIndex, visibility, fillColor} = ws.comments[ref];\r\n            const shape = vmlXml.ele('v:shape');\r\n            shape.att('id', `_${ws.sheetId}_${row}_${col}`);\r\n            shape.att('type', \"#_x0000_t202\");\r\n            shape.att('style', `position:${position};margin-left:${marginLeft};margin-top:${marginTop};width:${width};height:${height};z-index:${zIndex};visibility:${visibility}`);\r\n            shape.att('fillcolor', fillColor);\r\n            shape.att('o:insetmode', 'auto');\r\n\r\n            shape.ele('v:path').att('o:connecttype', 'none');\r\n\r\n            const tb = shape.ele('v:textbox').att('style', 'mso-direction-alt:auto');\r\n            tb.ele('div').att('style', 'text-align:left');\r\n\r\n            const cd = shape.ele('x:ClientData').att('ObjectType', 'Note');\r\n            cd.ele('x:MoveWithCells');\r\n            cd.ele('x:SizeWithCells');\r\n            cd.ele('x:AutoFill').text('False');\r\n            cd.ele('x:Row').text(row - 1);\r\n            cd.ele('x:Column').text(col - 1);\r\n        });\r\n\r\n\r\n        let xmlString = vmlXml.doc().end();\r\n        resolve(xmlString);\r\n    });\r\n}\r\n\r\nmodule.exports = { sheetXML, relsXML, commentsXML, commentsVmlXML };\r\n"]}