{"version":3,"sources":["../../../source/lib/drawing/picture.js"],"names":["Drawing","require","path","imgsz","mime","uniqueId","EMU","xmlbuilder","Picture","opts","kind","type","imagePath","image","_name","name","basename","size","_pxWidth","width","_pxHeight","height","_extension","extname","substr","contentType","getType","_descr","_title","_id","noGrp","noSelect","noRot","noChangeAspect","noMove","noResize","noEditPoints","noAdjustHandles","noChangeArrowheads","noChangeShapeType","indexOf","position","anchor","from","to","x","y","TypeError","ele","anchorEle","anchorType","editAs","att","_position","af","anchorFrom","afEle","text","col","colOff","row","rowOff","anchorTo","at","atEle","picEle","nvPicPrEle","cNvPrEle","description","id","title","cNvPicPrEle","blipFillEle","rId","spPrEle","xfrmEle","prstGeom","newName","desc","inWidth","emu","value","inHeight","module","exports"],"mappings":";;;;;;;;;;AAAA,IAAMA,UAAUC,QAAQ,cAAR,CAAhB;AACA,IAAMC,OAAOD,QAAQ,MAAR,CAAb;AACA,IAAME,QAAQF,QAAQ,YAAR,CAAd;AACA,IAAMG,OAAOH,QAAQ,MAAR,CAAb;AACA,IAAMI,WAAWJ,QAAQ,iBAAR,CAAjB;;AAEA,IAAMK,MAAML,QAAQ,mBAAR,CAAZ;AACA,IAAMM,aAAaN,QAAQ,YAAR,CAAnB;;IAEMO,O;;;AACF;;;;;;;;;;;;;;;;;;;;;;AAsBA,qBAAYC,IAAZ,EAAkB;AAAA;;AAAA;;AAEd,cAAKC,IAAL,GAAY,OAAZ;AACA,cAAKC,IAAL,GAAY,2EAAZ;AACA,cAAKC,SAAL,GAAiBH,KAAKP,IAAtB;AACA,cAAKW,KAAL,GAAaJ,KAAKI,KAAlB;;AAEA,cAAKC,KAAL,GAAa,MAAKD,KAAL,GACTJ,KAAKM,IAAL,IAAaV,SAAS,QAAT,CADJ,GAETI,KAAKM,IAAL,IAAab,KAAKc,QAAL,CAAc,MAAKJ,SAAnB,CAFjB;;AAIA,YAAMK,OAAOd,MAAM,MAAKS,SAAL,IAAkB,MAAKC,KAA7B,CAAb;;AAEA,cAAKK,QAAL,GAAgBD,KAAKE,KAArB;AACA,cAAKC,SAAL,GAAiBH,KAAKI,MAAtB;;AAEA,cAAKC,UAAL,GAAkB,MAAKT,KAAL,GACdI,KAAKN,IADS,GAEdT,KAAKqB,OAAL,CAAa,MAAKX,SAAlB,EAA6BY,MAA7B,CAAoC,CAApC,CAFJ;;AAIA,cAAKC,WAAL,GAAmBrB,KAAKsB,OAAL,CAAa,MAAKJ,UAAlB,CAAnB;;AAEA,cAAKK,MAAL,GAAc,IAAd;AACA,cAAKC,MAAL,GAAc,IAAd;AACA,cAAKC,GAAL;AACA;AACA,cAAKC,KAAL;AACA,cAAKC,QAAL;AACA,cAAKC,KAAL;AACA,cAAKC,cAAL,GAAsB,IAAtB;AACA,cAAKC,MAAL;AACA,cAAKC,QAAL;AACA,cAAKC,YAAL;AACA,cAAKC,eAAL;AACA,cAAKC,kBAAL;AACA,cAAKC,iBAAL;AACA,YAAI,CAAC,eAAD,EAAkB,eAAlB,EAAmCC,OAAnC,CAA2C/B,KAAKgC,QAAL,CAAc9B,IAAzD,KAAkE,CAAtE,EAAyE;AACrE,kBAAK+B,MAAL,CAAYjC,KAAKgC,QAAL,CAAc9B,IAA1B,EAAgCF,KAAKgC,QAAL,CAAcE,IAA9C,EAAoDlC,KAAKgC,QAAL,CAAcG,EAAlE;AACH,SAFD,MAEO,IAAInC,KAAKgC,QAAL,CAAc9B,IAAd,KAAuB,gBAA3B,EAA6C;AAChD,kBAAK8B,QAAL,CAAchC,KAAKgC,QAAL,CAAcI,CAA5B,EAA+BpC,KAAKgC,QAAL,CAAcK,CAA7C;AACH,SAFM,MAEA;AACH,kBAAM,IAAIC,SAAJ,CAAc,2GAAd,CAAN;AACH;AA1Ca;AA2CjB;;;;;;AAiDD;;;;;;oCAMYC,G,EAAK;;AAEb,gBAAIC,YAAYD,IAAIA,GAAJ,CAAQ,SAAS,KAAKE,UAAtB,CAAhB;;AAEA,gBAAI,KAAKC,MAAL,KAAgB,IAApB,EAA0B;AACtBF,0BAAUG,GAAV,CAAc,QAAd,EAAwB,KAAKD,MAA7B;AACH;;AAED,gBAAI,KAAKD,UAAL,KAAoB,gBAAxB,EAA0C;AACtCD,0BAAUD,GAAV,CAAc,SAAd,EAAyBI,GAAzB,CAA6B,GAA7B,EAAkC,KAAKC,SAAL,CAAeR,CAAjD,EAAoDO,GAApD,CAAwD,GAAxD,EAA6D,KAAKC,SAAL,CAAeP,CAA5E;AACH;;AAED,gBAAI,KAAKI,UAAL,KAAoB,gBAAxB,EAA0C;AACtC,oBAAII,KAAK,KAAKC,UAAd;AACA,oBAAIC,QAAQP,UAAUD,GAAV,CAAc,UAAd,CAAZ;AACAQ,sBAAMR,GAAN,CAAU,SAAV,EAAqBS,IAArB,CAA0BH,GAAGI,GAA7B;AACAF,sBAAMR,GAAN,CAAU,YAAV,EAAwBS,IAAxB,CAA6BH,GAAGK,MAAhC;AACAH,sBAAMR,GAAN,CAAU,SAAV,EAAqBS,IAArB,CAA0BH,GAAGM,GAA7B;AACAJ,sBAAMR,GAAN,CAAU,YAAV,EAAwBS,IAAxB,CAA6BH,GAAGO,MAAhC;AACH;;AAED,gBAAI,KAAKC,QAAL,IAAiB,KAAKZ,UAAL,KAAoB,eAAzC,EAA0D;AACtD,oBAAIa,KAAK,KAAKD,QAAd;AACA,oBAAIE,QAAQf,UAAUD,GAAV,CAAc,QAAd,CAAZ;AACAgB,sBAAMhB,GAAN,CAAU,SAAV,EAAqBS,IAArB,CAA0BM,GAAGL,GAA7B;AACAM,sBAAMhB,GAAN,CAAU,YAAV,EAAwBS,IAAxB,CAA6BM,GAAGJ,MAAhC;AACAK,sBAAMhB,GAAN,CAAU,SAAV,EAAqBS,IAArB,CAA0BM,GAAGH,GAA7B;AACAI,sBAAMhB,GAAN,CAAU,YAAV,EAAwBS,IAAxB,CAA6BM,GAAGF,MAAhC;AACH;;AAED,gBAAI,KAAKX,UAAL,KAAoB,eAApB,IAAuC,KAAKA,UAAL,KAAoB,gBAA/D,EAAiF;AAC7ED,0BAAUD,GAAV,CAAc,SAAd,EAAyBI,GAAzB,CAA6B,IAA7B,EAAmC,KAAKjC,KAAxC,EAA+CiC,GAA/C,CAAmD,IAAnD,EAAyD,KAAK/B,MAA9D;AACH;;AAED,gBAAI4C,SAAShB,UAAUD,GAAV,CAAc,SAAd,CAAb;AACA,gBAAIkB,aAAaD,OAAOjB,GAAP,CAAW,aAAX,CAAjB;AACA,gBAAImB,WAAWD,WAAWlB,GAAX,CAAe,WAAf,CAAf;AACAmB,qBAASf,GAAT,CAAa,OAAb,EAAsB,KAAKgB,WAA3B;AACAD,qBAASf,GAAT,CAAa,IAAb,EAAmB,KAAKiB,EAAL,GAAU,CAA7B;AACAF,qBAASf,GAAT,CAAa,MAAb,EAAqB,KAAKrC,IAA1B;AACAoD,qBAASf,GAAT,CAAa,OAAb,EAAsB,KAAKkB,KAA3B;AACA,gBAAIC,cAAcL,WAAWlB,GAAX,CAAe,cAAf,CAAlB;;AAEA,iBAAKlB,KAAL,KAAe,IAAf,GAAsByC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,OAAlC,EAA2C,CAA3C,CAAtB,GAAsE,IAAtE;AACA,iBAAKrB,QAAL,KAAkB,IAAlB,GAAyBwC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,UAAlC,EAA8C,CAA9C,CAAzB,GAA4E,IAA5E;AACA,iBAAKpB,KAAL,KAAe,IAAf,GAAsBuC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,OAAlC,EAA2C,CAA3C,CAAtB,GAAsE,IAAtE;AACA,iBAAKnB,cAAL,KAAwB,IAAxB,GAA+BsC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,gBAAlC,EAAoD,CAApD,CAA/B,GAAwF,IAAxF;AACA,iBAAKlB,MAAL,KAAgB,IAAhB,GAAuBqC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,QAAlC,EAA4C,CAA5C,CAAvB,GAAwE,IAAxE;AACA,iBAAKjB,QAAL,KAAkB,IAAlB,GAAyBoC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,UAAlC,EAA8C,CAA9C,CAAzB,GAA4E,IAA5E;AACA,iBAAKhB,YAAL,KAAsB,IAAtB,GAA6BmC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,cAAlC,EAAkD,CAAlD,CAA7B,GAAoF,IAApF;AACA,iBAAKf,eAAL,KAAyB,IAAzB,GAAgCkC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,iBAAlC,EAAqD,CAArD,CAAhC,GAA0F,IAA1F;AACA,iBAAKd,kBAAL,KAA4B,IAA5B,GAAmCiC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,oBAAlC,EAAwD,CAAxD,CAAnC,GAAgG,IAAhG;AACA,iBAAKb,iBAAL,KAA2B,IAA3B,GAAkCgC,YAAYvB,GAAZ,CAAgB,YAAhB,EAA8BI,GAA9B,CAAkC,mBAAlC,EAAuD,CAAvD,CAAlC,GAA8F,IAA9F;;AAEA,gBAAIoB,cAAcP,OAAOjB,GAAP,CAAW,cAAX,CAAlB;AACAwB,wBAAYxB,GAAZ,CAAgB,QAAhB,EAA0BI,GAA1B,CAA8B,SAA9B,EAAyC,KAAKqB,GAA9C,EAAmDrB,GAAnD,CAAuD,SAAvD,EAAkE,qEAAlE;AACAoB,wBAAYxB,GAAZ,CAAgB,WAAhB,EAA6BA,GAA7B,CAAiC,YAAjC;;AAEA,gBAAI0B,UAAUT,OAAOjB,GAAP,CAAW,UAAX,CAAd;AACA,gBAAI2B,UAAUD,QAAQ1B,GAAR,CAAY,QAAZ,CAAd;AACA2B,oBAAQ3B,GAAR,CAAY,OAAZ,EAAqBI,GAArB,CAAyB,GAAzB,EAA8B,CAA9B,EAAiCA,GAAjC,CAAqC,GAArC,EAA0C,CAA1C;AACAuB,oBAAQ3B,GAAR,CAAY,OAAZ,EAAqBI,GAArB,CAAyB,IAAzB,EAA+B,KAAKjC,KAApC,EAA2CiC,GAA3C,CAA+C,IAA/C,EAAqD,KAAK/B,MAA1D;;AAEA,gBAAIuD,WAAWF,QAAQ1B,GAAR,CAAY,YAAZ,EAA0BI,GAA1B,CAA8B,MAA9B,EAAsC,MAAtC,CAAf;AACAwB,qBAAS5B,GAAT,CAAa,SAAb;;AAEAC,sBAAUD,GAAV,CAAc,gBAAd;AACH;;;4BAxHU;AACP,mBAAO,KAAKlC,KAAZ;AACH,S;0BACQ+D,O,EAAS;AACd,iBAAK/D,KAAL,GAAa+D,OAAb;AACH;;;4BACQ;AACL,mBAAO,KAAKhD,GAAZ;AACH,S;0BACMwC,E,EAAI;AACP,iBAAKxC,GAAL,GAAWwC,EAAX;AACH;;;4BAES;AACN,mBAAO,QAAQ,KAAKxC,GAApB;AACH;;;4BAEiB;AACd,mBAAO,KAAKF,MAAL,KAAgB,IAAhB,GAAuB,KAAKA,MAA5B,GAAqC,KAAKb,KAAjD;AACH,S;0BACegE,I,EAAM;AAClB,iBAAKnD,MAAL,GAAcmD,IAAd;AACH;;;4BAEW;AACR,mBAAO,KAAKlD,MAAL,KAAgB,IAAhB,GAAuB,KAAKA,MAA5B,GAAqC,KAAKd,KAAjD;AACH,S;0BACSwD,K,EAAO;AACb,iBAAK1C,MAAL,GAAc0C,KAAd;AACH;;;4BAEe;AACZ,mBAAO,KAAKhD,UAAZ;AACH;;;4BAEW;AACR,gBAAIyD,UAAU,KAAK7D,QAAL,GAAgB,EAA9B;AACA,gBAAI8D,MAAM,IAAI1E,GAAJ,CAAQyE,UAAU,IAAlB,CAAV;AACA,mBAAOC,IAAIC,KAAX;AACH;;;4BAEY;AACT,gBAAIC,WAAW,KAAK9D,SAAL,GAAiB,EAAhC;AACA,gBAAI4D,MAAM,IAAI1E,GAAJ,CAAQ4E,WAAW,IAAnB,CAAV;AACA,mBAAOF,IAAIC,KAAX;AACH;;;;EAjHiBjF,O;;AA+LtBmF,OAAOC,OAAP,GAAiB5E,OAAjB","file":"picture.js","sourcesContent":["const Drawing = require('./drawing.js');\r\nconst path = require('path');\r\nconst imgsz = require('image-size');\r\nconst mime = require('mime');\r\nconst uniqueId = require('lodash.uniqueid');\r\n\r\nconst EMU = require('../classes/emu.js');\r\nconst xmlbuilder = require('xmlbuilder');\r\n\r\nclass Picture extends Drawing {\r\n    /**\r\n     * Element representing an Excel Picture subclass of Drawing\r\n     * @property {String} kind Kind of picture (currently only image is supported)\r\n     * @property {String} type ooxml schema\r\n     * @property {String} imagePath Filesystem path to image\r\n     * @property {Buffer} image Buffer with image\r\n     * @property {String} contentType Mime type of image\r\n     * @property {String} description Description of image\r\n     * @property {String} title Title of image\r\n     * @property {String} id ID of image\r\n     * @property {String} noGrp pickLocks property\r\n     * @property {String} noSelect pickLocks property\r\n     * @property {String} noRot pickLocks property\r\n     * @property {String} noChangeAspect pickLocks property\r\n     * @property {String} noMove pickLocks property\r\n     * @property {String} noResize pickLocks property\r\n     * @property {String} noEditPoints pickLocks property\r\n     * @property {String} noAdjustHandles pickLocks property\r\n     * @property {String} noChangeArrowheads pickLocks property\r\n     * @property {String} noChangeShapeType pickLocks property\r\n     * @returns {Picture} Excel Picture  pickLocks property\r\n     */\r\n    constructor(opts) {\r\n        super();\r\n        this.kind = 'image';\r\n        this.type = 'http://schemas.openxmlformats.org/officeDocument/2006/relationships/image';\r\n        this.imagePath = opts.path;\r\n        this.image = opts.image;\r\n\r\n        this._name = this.image ?\r\n            opts.name || uniqueId('image-') :\r\n            opts.name || path.basename(this.imagePath);\r\n\r\n        const size = imgsz(this.imagePath || this.image);\r\n\r\n        this._pxWidth = size.width;\r\n        this._pxHeight = size.height;\r\n\r\n        this._extension = this.image ?\r\n            size.type :\r\n            path.extname(this.imagePath).substr(1);\r\n\r\n        this.contentType = mime.getType(this._extension);\r\n\r\n        this._descr = null;\r\n        this._title = null;\r\n        this._id;\r\n        // picLocks ยง20.1.2.2.31 picLocks (Picture Locks)\r\n        this.noGrp;\r\n        this.noSelect;\r\n        this.noRot;\r\n        this.noChangeAspect = true;\r\n        this.noMove;\r\n        this.noResize;\r\n        this.noEditPoints;\r\n        this.noAdjustHandles;\r\n        this.noChangeArrowheads;\r\n        this.noChangeShapeType;\r\n        if (['oneCellAnchor', 'twoCellAnchor'].indexOf(opts.position.type) >= 0) {\r\n            this.anchor(opts.position.type, opts.position.from, opts.position.to);\r\n        } else if (opts.position.type === 'absoluteAnchor') {\r\n            this.position(opts.position.x, opts.position.y);\r\n        } else {\r\n            throw new TypeError('Invalid option for anchor type. anchorType must be one of oneCellAnchor, twoCellAnchor, or absoluteAnchor');\r\n        }\r\n    }\r\n\r\n    get name() {\r\n        return this._name;\r\n    }\r\n    set name(newName) {\r\n        this._name = newName;\r\n    }\r\n    get id() {\r\n        return this._id;\r\n    }\r\n    set id(id) {\r\n        this._id = id;\r\n    }\r\n\r\n    get rId() {\r\n        return 'rId' + this._id;\r\n    }\r\n\r\n    get description() {\r\n        return this._descr !== null ? this._descr : this._name;\r\n    }\r\n    set description(desc) {\r\n        this._descr = desc;\r\n    }\r\n\r\n    get title() {\r\n        return this._title !== null ? this._title : this._name;\r\n    }\r\n    set title(title) {\r\n        this._title = title;\r\n    }\r\n\r\n    get extension() {\r\n        return this._extension;\r\n    }\r\n\r\n    get width() {\r\n        let inWidth = this._pxWidth / 96;\r\n        let emu = new EMU(inWidth + 'in');\r\n        return emu.value;\r\n    }\r\n\r\n    get height() {\r\n        let inHeight = this._pxHeight / 96;\r\n        let emu = new EMU(inHeight + 'in');\r\n        return emu.value;\r\n    }\r\n\r\n    /**\r\n     * @alias Picture.addToXMLele\r\n     * @desc When generating Workbook output, attaches pictures to the drawings xml file\r\n     * @func Picture.addToXMLele\r\n     * @param {xmlbuilder.Element} ele Element object of the xmlbuilder module\r\n     */\r\n    addToXMLele(ele) {\r\n\r\n        let anchorEle = ele.ele('xdr:' + this.anchorType);\r\n\r\n        if (this.editAs !== null) {\r\n            anchorEle.att('editAs', this.editAs);\r\n        }\r\n\r\n        if (this.anchorType === 'absoluteAnchor') {\r\n            anchorEle.ele('xdr:pos').att('x', this._position.x).att('y', this._position.y);\r\n        }\r\n\r\n        if (this.anchorType !== 'absoluteAnchor') {\r\n            let af = this.anchorFrom;\r\n            let afEle = anchorEle.ele('xdr:from');\r\n            afEle.ele('xdr:col').text(af.col);\r\n            afEle.ele('xdr:colOff').text(af.colOff);\r\n            afEle.ele('xdr:row').text(af.row);\r\n            afEle.ele('xdr:rowOff').text(af.rowOff);\r\n        }\r\n\r\n        if (this.anchorTo && this.anchorType === 'twoCellAnchor') {\r\n            let at = this.anchorTo;\r\n            let atEle = anchorEle.ele('xdr:to');\r\n            atEle.ele('xdr:col').text(at.col);\r\n            atEle.ele('xdr:colOff').text(at.colOff);\r\n            atEle.ele('xdr:row').text(at.row);\r\n            atEle.ele('xdr:rowOff').text(at.rowOff);\r\n        }\r\n\r\n        if (this.anchorType === 'oneCellAnchor' || this.anchorType === 'absoluteAnchor') {\r\n            anchorEle.ele('xdr:ext').att('cx', this.width).att('cy', this.height);\r\n        }\r\n\r\n        let picEle = anchorEle.ele('xdr:pic');\r\n        let nvPicPrEle = picEle.ele('xdr:nvPicPr');\r\n        let cNvPrEle = nvPicPrEle.ele('xdr:cNvPr');\r\n        cNvPrEle.att('descr', this.description);\r\n        cNvPrEle.att('id', this.id + 1);\r\n        cNvPrEle.att('name', this.name);\r\n        cNvPrEle.att('title', this.title);\r\n        let cNvPicPrEle = nvPicPrEle.ele('xdr:cNvPicPr');\r\n\r\n        this.noGrp === true ? cNvPicPrEle.ele('a:picLocks').att('noGrp', 1) : null;\r\n        this.noSelect === true ? cNvPicPrEle.ele('a:picLocks').att('noSelect', 1) : null;\r\n        this.noRot === true ? cNvPicPrEle.ele('a:picLocks').att('noRot', 1) : null;\r\n        this.noChangeAspect === true ? cNvPicPrEle.ele('a:picLocks').att('noChangeAspect', 1) : null;\r\n        this.noMove === true ? cNvPicPrEle.ele('a:picLocks').att('noMove', 1) : null;\r\n        this.noResize === true ? cNvPicPrEle.ele('a:picLocks').att('noResize', 1) : null;\r\n        this.noEditPoints === true ? cNvPicPrEle.ele('a:picLocks').att('noEditPoints', 1) : null;\r\n        this.noAdjustHandles === true ? cNvPicPrEle.ele('a:picLocks').att('noAdjustHandles', 1) : null;\r\n        this.noChangeArrowheads === true ? cNvPicPrEle.ele('a:picLocks').att('noChangeArrowheads', 1) : null;\r\n        this.noChangeShapeType === true ? cNvPicPrEle.ele('a:picLocks').att('noChangeShapeType', 1) : null;\r\n\r\n        let blipFillEle = picEle.ele('xdr:blipFill');\r\n        blipFillEle.ele('a:blip').att('r:embed', this.rId).att('xmlns:r', 'http://schemas.openxmlformats.org/officeDocument/2006/relationships');\r\n        blipFillEle.ele('a:stretch').ele('a:fillRect');\r\n\r\n        let spPrEle = picEle.ele('xdr:spPr');\r\n        let xfrmEle = spPrEle.ele('a:xfrm');\r\n        xfrmEle.ele('a:off').att('x', 0).att('y', 0);\r\n        xfrmEle.ele('a:ext').att('cx', this.width).att('cy', this.height);\r\n\r\n        let prstGeom = spPrEle.ele('a:prstGeom').att('prst', 'rect');\r\n        prstGeom.ele('a:avLst');\r\n\r\n        anchorEle.ele('xdr:clientData');\r\n    }\r\n}\r\n\r\nmodule.exports = Picture;"]}